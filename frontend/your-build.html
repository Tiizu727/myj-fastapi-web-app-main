<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<title>ã‚ãªãŸã®æ§‹æˆ</title>
		<!-- cssãƒ•ã‚¡ã‚¤ãƒ«ã‚’import -->
		<link rel="stylesheet" href="/css/general.css" />
	</head>

	<body>
		<div class="header">
			<div class="header-content">
				<img src="/img/logo.png" alt="Logo" class="logo" />
				<a href="/index.html" class="site-title-link">
					<h1 class="site-title">ã ã‚Œã§ã‚‚è‡ªä½œPCãƒŠãƒ“</h1>
				</a>
			</div>
		</div>
		
		<div class="main-container">
			<div class="page-header">
				<h1 class="page-title">ã‚ãªãŸã®PCæ§‹æˆ</h1>
				<p class="page-subtitle">é¸æŠã—ãŸãƒ‘ãƒ¼ãƒ„ã®æ§‹æˆã‚’ã”ç¢ºèªãã ã•ã„</p>
			</div>
			
			<div class="build-summary">
				<div class="build-summary-header">
					<h2>æ§‹æˆä¸€è¦§</h2>
					<div class="build-status">
						<span class="status-indicator" id="status-indicator">æ§‹æˆãƒã‚§ãƒƒã‚¯ä¸­...</span>
					</div>
				</div>
				
				<div class="build-grid" id="product-list">
					<!-- ã“ã“ã«æ§‹æˆãƒ‘ãƒ¼ãƒ„ãŒå…¥ã‚‹ -->
				</div>
				
				<div class="build-actions">
					<button onclick="move()" class="save-button">
						<i class="icon">ğŸ’¾</i>
						æ§‹æˆã‚’ä¿å­˜
					</button>
					<button onclick="startOver()" class="restart-button">
						<i class="icon">ğŸ”„</i>
						æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
					</button>
				</div>
			</div>
		</div>

		<script>
			const params = new URLSearchParams(window.location.search);
			const API_BASE_URL = "http://localhost:8000";
			const productsList = document.getElementById("product-list");
			const statusIndicator = document.getElementById("status-indicator");
			
			// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ†ã‚´ãƒªã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°
			const partCategories = {
				cpu: { name: "CPU", icon: "ğŸ§ " },
				gpu: { name: "GPU", icon: "ğŸ®" },
				memory: { name: "ãƒ¡ãƒ¢ãƒª", icon: "ğŸ’¾" },
				storage: { name: "ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸", icon: "ğŸ’¿" },
				mb: { name: "ãƒã‚¶ãƒ¼ãƒœãƒ¼ãƒ‰", icon: "ğŸ”§" },
				cooler: { name: "ã‚¯ãƒ¼ãƒ©ãƒ¼", icon: "â„ï¸" },
				psu: { name: "é›»æºãƒ¦ãƒ‹ãƒƒãƒˆ", icon: "âš¡" },
				case: { name: "ã‚±ãƒ¼ã‚¹", icon: "ğŸ“¦" },
				os: { name: "OS", icon: "ğŸ’»" }
			};

			const partIds = {
				cpu: localStorage.getItem("cpu"),
				gpu: localStorage.getItem("gpu"),
				memory: localStorage.getItem("memory"),
				storage: localStorage.getItem("storage"),
				mb: localStorage.getItem("mb"),
				cooler: localStorage.getItem("cooler"),
				psu: localStorage.getItem("psu"),
				case: localStorage.getItem("case"),
				os: localStorage.getItem("os")
			};

			// é¸æŠã•ã‚ŒãŸãƒ‘ãƒ¼ãƒ„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
			const selectedParts = Object.entries(partIds).filter(([key, id]) => 
				id && id !== "null" && id !== "undefined"
			);

			async function fetchProductsInOrder() {
				productsList.innerHTML = '';
				let completedParts = 0;
				
				for (const [category, id] of selectedParts) {
					const categoryInfo = partCategories[category];
					
					// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
					const partCard = document.createElement("div");
					partCard.className = "build-part-card loading";
					partCard.id = `part-${category}`;
					partCard.innerHTML = `
						<div class="part-category">
							<span class="part-icon">${categoryInfo.icon}</span>
							<span class="part-name">${categoryInfo.name}</span>
						</div>
						<div class="part-content">
							<div class="loading-spinner">èª­ã¿è¾¼ã¿ä¸­...</div>
						</div>
					`;
					productsList.appendChild(partCard);
					
					try {
						const ENDPOINT = `product-by-id/${id}`;
						const DB_URL = `${API_BASE_URL}/${ENDPOINT}`;
						const response = await fetch(DB_URL, {
							method: "GET",
							headers: {
								Authorization: `Bearer ${localStorage.getItem("token")}`,
							},
						});
						
						if (!response.ok) {
							throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
						}
						
						const jsonObj = await response.json();
						const product = jsonObj.length ? jsonObj[0] : jsonObj;
						
						// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
						partCard.className = "build-part-card loaded";
						partCard.innerHTML = `
							<div class="part-category">
								<span class="part-icon">${categoryInfo.icon}</span>
								<span class="part-name">${categoryInfo.name}</span>
							</div>
							<div class="part-content">
								<div class="part-image">
									<img src="${product.image_url}" alt="${product.name}">
								</div>
								<div class="part-info">
									<div class="part-maker">${product.maker}</div>
									<h3 class="part-product-name">${product.name}</h3>
									<div class="part-actions">
										<a href="${product.information_url}" class="info-link" target="_blank">è©³ç´°æƒ…å ±</a>
										<button onclick="changePart('${category}')" class="change-button">å¤‰æ›´</button>
									</div>
								</div>
							</div>
						`;
						
						completedParts++;
						
					} catch (error) {
						console.error(`${category}ã‚¨ãƒ©ãƒ¼:`, error);
						partCard.className = "build-part-card error";
						partCard.innerHTML = `
							<div class="part-category">
								<span class="part-icon">${categoryInfo.icon}</span>
								<span class="part-name">${categoryInfo.name}</span>
							</div>
							<div class="part-content">
								<div class="error-message">
									<span>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>
									<button onclick="changePart('${category}')" class="change-button">å†é¸æŠ</button>
								</div>
							</div>
						`;
					}
				}
				
				// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
				if (completedParts === selectedParts.length && selectedParts.length > 0) {
					statusIndicator.textContent = `æ§‹æˆå®Œäº† (${completedParts}/${Object.keys(partCategories).length}ãƒ‘ãƒ¼ãƒ„)`;
					statusIndicator.className = "status-indicator complete";
				} else if (selectedParts.length === 0) {
					statusIndicator.textContent = "ãƒ‘ãƒ¼ãƒ„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
					statusIndicator.className = "status-indicator empty";
					productsList.innerHTML = `
						<div class="empty-build">
							<div class="empty-icon">ğŸ› ï¸</div>
							<h3>ãƒ‘ãƒ¼ãƒ„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
							<p>ã¾ãšã¯ãƒ‘ãƒ¼ãƒ„ã‚’é¸æŠã—ã¦PCæ§‹æˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
							<button onclick="startOver()" class="start-button">ãƒ‘ãƒ¼ãƒ„é¸æŠã‚’é–‹å§‹</button>
						</div>
					`;
				} else {
					statusIndicator.textContent = `æ§‹æˆä¸­ (${completedParts}/${Object.keys(partCategories).length}ãƒ‘ãƒ¼ãƒ„)`;
					statusIndicator.className = "status-indicator partial";
				}
			}

			// ãƒ‘ãƒ¼ãƒ„å¤‰æ›´é–¢æ•°
			function changePart(category) {
				const pageMap = {
					cpu: "/cpu.html",
					gpu: "/gpu.html", 
					memory: "/memory.html",
					storage: "/storage.html",
					mb: "/motherboard.html",
					cooler: "/cooler.html",
					psu: "/powersupply.html",
					case: "/case.html",
					os: "/os.html"
				};
				
				if (pageMap[category]) {
					location.href = pageMap[category];
				}
			}

			// æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™é–¢æ•°
			function startOver() {
				if (confirm("ç¾åœ¨ã®æ§‹æˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
					Object.keys(partCategories).forEach(key => {
						localStorage.removeItem(key);
					});
					location.href = "/index.html";
				}
			}

			// ä¿å­˜é–¢æ•°
			function move() {
				if (selectedParts.length === 0) {
					alert("ä¿å­˜ã™ã‚‹ãƒ‘ãƒ¼ãƒ„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
					return;
				}
				location.href = "./save-build.html";
			}

			// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
			fetchProductsInOrder();
		</script>
	</body>
</html>