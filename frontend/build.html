<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>æ§‹æˆè©³ç´° - ã ã‚Œã§ã‚‚è‡ªä½œPCãƒŠãƒ“</title>
		<link rel="stylesheet" href="/css/general.css" />

		<!-- jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’import -->
		<script type="text/javascript" src="/js/general.js"></script>
		<script type="text/javascript" src="/js/api.js"></script>
	</head>
	<body>
		<div class="header">
			<div class="header-content">
				<img src="/img/logo.png" alt="Logo" class="logo" />
				<a href="/index.html" class="site-title-link">
					<h1 class="site-title">ã ã‚Œã§ã‚‚è‡ªä½œPCãƒŠãƒ“</h1>
				</a>
			</div>
		</div>

		<div class="main-container">
			<div class="page-header">
				<h1 class="page-title">PCæ§‹æˆè©³ç´°</h1>
				<p class="page-subtitle">ä¿å­˜ã•ã‚ŒãŸæ§‹æˆã®è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„</p>
			</div>

			<div class="build-detail-container">
				<div id="message-area" class="hidden"></div>
				
				<div class="build-detail-header">
					<div id="build-name" class="build-name-section">
						<div class="build-icon-large">ğŸ–¥ï¸</div>
						<div class="loading-text">æ§‹æˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
					</div>
					<div class="build-actions">
						<button onclick="move()" class="back-button">
							<span class="button-icon">â†</span>
							ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
						</button>
					</div>
				</div>

				<div class="build-content">
					<div class="build-summary">
						<div class="build-summary-header">
							<h2>ãƒ‘ãƒ¼ãƒ„æ§‹æˆ</h2>
							<div class="build-status">
								<span class="status-indicator" id="status-indicator">èª­ã¿è¾¼ã¿ä¸­...</span>
							</div>
						</div>
						
						<div class="build-grid" id="build-detail">
							<!-- ã“ã“ã«æ§‹æˆãƒ‘ãƒ¼ãƒ„ãŒå…¥ã‚‹ -->
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const API_BASE_URL = "http://localhost:8000";
			const BUILD_PATH = "build";
			const buildDetail = document.getElementById("build-detail");
			const statusIndicator = document.getElementById("status-indicator");
			const buildNameSection = document.getElementById("build-name");

			// URLã‹ã‚‰è¨˜äº‹IDã‚’å–å¾—ã™ã‚‹
			const urlParams = new URLSearchParams(window.location.search);
			const buildId = urlParams.get("buildId");

			// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ†ã‚´ãƒªã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°
			const partCategories = {
				cpu: { name: "CPU", icon: "ğŸ§ " },
				gpu: { name: "GPU", icon: "ğŸ®" },
				memory: { name: "ãƒ¡ãƒ¢ãƒª", icon: "ğŸ’¾" },
				storage: { name: "ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸", icon: "ğŸ’¿" },
				mb: { name: "ãƒã‚¶ãƒ¼ãƒœãƒ¼ãƒ‰", icon: "ğŸ”§" },
				cooler: { name: "ã‚¯ãƒ¼ãƒ©ãƒ¼", icon: "â„ï¸" },
				psu: { name: "é›»æºãƒ¦ãƒ‹ãƒƒãƒˆ", icon: "âš¡" },
				case: { name: "ã‚±ãƒ¼ã‚¹", icon: "ğŸ“¦" },
				OS: { name: "OS", icon: "ğŸ’»" }
			};

			if (!buildId) {
				buildDetail.innerHTML = `
					<div class="error-card">
						<div class="error-icon">âš ï¸</div>
						<h3>æ§‹æˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
						<p>æ­£ã—ã„URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</p>
						<button onclick="move()" class="retry-button">
							<span class="button-icon">â†</span>
							ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
						</button>
					</div>
				`;
				statusIndicator.textContent = "ã‚¨ãƒ©ãƒ¼";
				statusIndicator.className = "status-indicator empty";
			} else {
				const BUILD_DETAIL_URL = `${API_BASE_URL}/${BUILD_PATH}/${buildId}`;

				async function fetchPartsId() {
					try {
						const response = await fetch(BUILD_DETAIL_URL, {
							method: "GET",
							headers: {
								Authorization: `Bearer ${localStorage.getItem("token")}`,
							},
						});
						if (!response.ok) {
							throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
						}
						const jsonObj = await response.json();
						if (Object.keys(jsonObj).length == 0) {
							buildDetail.innerHTML = `
								<div class="error-card">
									<div class="error-icon">ğŸ”</div>
									<h3>è©²å½“ã™ã‚‹æ§‹æˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
									<p>æ§‹æˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</p>
									<button onclick="move()" class="retry-button">
										<span class="button-icon">â†</span>
										ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
									</button>
								</div>
							`;
							return null;
						} else {
							// æ§‹æˆåã‚’è¡¨ç¤º
							const buildName = jsonObj.name || 'PCæ§‹æˆ';
							buildNameSection.innerHTML = `
								<div class="build-icon-large">ğŸ–¥ï¸</div>
								<div class="build-info-large">
									<h1 class="build-title">${buildName}</h1>
									<p class="build-subtitle">ä½œæˆæ—¥: ${jsonObj.created_at ? new Date(jsonObj.created_at).toLocaleDateString('ja-JP') : 'ä¸æ˜'}</p>
								</div>
							`;

							const partIds = {
								cpu: jsonObj.cpu,
								gpu: jsonObj.gpu,
								memory: jsonObj.memory,
								storage: jsonObj.storage,
								mb: jsonObj.mb,
								cooler: jsonObj.cooler,
								psu: jsonObj.psu,
								case: jsonObj.case,
								OS: jsonObj.OS
							};

							// nullã‚„æœªå®šç¾©ã§ãªã„IDã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
							const validParts = Object.entries(partIds).filter(([key, id]) => 
								id && id !== "null" && id !== "undefined"
							);

							return validParts;
						}
					} catch (error) {
						console.error("ã‚¨ãƒ©ãƒ¼:", error);
						buildDetail.innerHTML = `
							<div class="error-card">
								<div class="error-icon">âš ï¸</div>
								<h3>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
								<p>${error.message}</p>
								<button onclick="location.reload()" class="retry-button">
									<span class="button-icon">ğŸ”„</span>
									å†è©¦è¡Œ
								</button>
							</div>
						`;
						statusIndicator.textContent = "ã‚¨ãƒ©ãƒ¼";
						statusIndicator.className = "status-indicator empty";
						return null;
					}
				}

				// æ§‹æˆå–å¾—å¾Œã«ãƒ‘ãƒ¼ãƒ„æƒ…å ±ã‚’é †ç•ªã«å–å¾—ãƒ»è¡¨ç¤º
				(async () => {
					const validParts = await fetchPartsId();
					if (validParts) {
						await fetchProductsInOrder(validParts);
					}
				})();
			}

			async function fetchProductsInOrder(validParts) {
				buildDetail.innerHTML = '';
				let completedParts = 0;

				for (const [category, id] of validParts) {
					const categoryInfo = partCategories[category];
					
					// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
					const partCard = document.createElement("div");
					partCard.className = "build-part-card loading";
					partCard.id = `part-${category}`;
					partCard.innerHTML = `
						<div class="part-category">
							<span class="part-icon">${categoryInfo.icon}</span>
							<span class="part-name">${categoryInfo.name}</span>
						</div>
						<div class="part-content">
							<div class="loading-spinner">èª­ã¿è¾¼ã¿ä¸­...</div>
						</div>
					`;
					buildDetail.appendChild(partCard);
					
					try {
						const ENDPOINT = `product-by-id/${id}`;
						const DB_URL = `${API_BASE_URL}/${ENDPOINT}`;
						const response = await fetch(DB_URL, {
							method: "GET",
							headers: {
								Authorization: `Bearer ${localStorage.getItem("token")}`,
							},
						});
						
						if (!response.ok) {
							throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
						}
						
						const jsonObj = await response.json();
						if (Object.keys(jsonObj).length == 0) {
							partCard.className = "build-part-card error";
							partCard.innerHTML = `
								<div class="part-category">
									<span class="part-icon">${categoryInfo.icon}</span>
									<span class="part-name">${categoryInfo.name}</span>
								</div>
								<div class="part-content">
									<div class="error-message">
										<span>è©²å½“ã™ã‚‹ãƒ‘ãƒ¼ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>
									</div>
								</div>
							`;
						} else {
							const product = jsonObj.length ? jsonObj[0] : jsonObj;
							
							// ãƒ‘ãƒ¼ãƒ„ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
							partCard.className = "build-part-card loaded";
							partCard.innerHTML = `
								<div class="part-category">
									<span class="part-icon">${categoryInfo.icon}</span>
									<span class="part-name">${categoryInfo.name}</span>
								</div>
								<div class="part-content">
									<div class="part-image">
										<img src="${product.image_url}" alt="${product.name}">
									</div>
									<div class="part-info">
										<div class="part-maker">${product.maker}</div>
										<h3 class="part-product-name">${product.name}</h3>
										<div class="part-actions">
											<a href="${product.information_url}" class="info-link" target="_blank">è©³ç´°æƒ…å ±</a>
										</div>
									</div>
								</div>
							`;
							
							completedParts++;
						}
					} catch (error) {
						console.error(`${category}ã‚¨ãƒ©ãƒ¼:`, error);
						partCard.className = "build-part-card error";
						partCard.innerHTML = `
							<div class="part-category">
								<span class="part-icon">${categoryInfo.icon}</span>
								<span class="part-name">${categoryInfo.name}</span>
							</div>
							<div class="part-content">
								<div class="error-message">
									<span>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>
								</div>
							</div>
						`;
					}
				}

				// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
				if (completedParts === validParts.length && validParts.length > 0) {
					statusIndicator.textContent = `æ§‹æˆå®Œäº† (${completedParts}ãƒ‘ãƒ¼ãƒ„)`;
					statusIndicator.className = "status-indicator complete";
				} else if (validParts.length === 0) {
					statusIndicator.textContent = "ãƒ‘ãƒ¼ãƒ„æƒ…å ±ãªã—";
					statusIndicator.className = "status-indicator empty";
					buildDetail.innerHTML = `
						<div class="empty-build">
							<div class="empty-icon">ğŸ“¦</div>
							<h3>ãƒ‘ãƒ¼ãƒ„æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</h3>
							<p>ã“ã®æ§‹æˆã«ã¯ãƒ‘ãƒ¼ãƒ„æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
						</div>
					`;
				} else {
					statusIndicator.textContent = `ä¸€éƒ¨èª­ã¿è¾¼ã¿å®Œäº† (${completedParts}/${validParts.length}ãƒ‘ãƒ¼ãƒ„)`;
					statusIndicator.className = "status-indicator partial";
				}
			}

            function move() {
				location.href = `./mypage.html`;
			}
		</script>
	</body>
</html>